---
import Layout from "../../layouts/BlogPost.astro";
import { getBlogs, getBlogDetail } from "../../library/microcms";

// 生成する記事のIDを全て取得
export async function getStaticPaths() {
  const response = await getBlogs({ fields: ["id"] });
  return response.contents.map((content: any) => ({
    params: {
      blogId: content.id,
    },
  }));
}

//記事の詳細情報を取得
const { blogId } = Astro.params;
const blog = await getBlogDetail(blogId as string);

//次の記事のIDを取得
const nextBlogResponse = await getBlogs({ limit: 1, filters: `publishedAt[greater_than]`+ blog.publishedAt, orders:"publishedAt", fields: ["id", "title"]})
const nextBlogId = nextBlogResponse.contents[0]?.id
const nextBlogTitle = nextBlogResponse.contents[0]?.title

//前の記事のIDを取得
const prevBlogResponse = await getBlogs({ limit: 1, filters: `publishedAt[less_than]`+ blog.publishedAt, orders:"-publishedAt", fields: ["id", "title"]})
const prevBlogId = prevBlogResponse.contents[0]?.id
const prevBlogTitle = prevBlogResponse.contents[0]?.title

//本文記事用配列
const article: Array<string> = []
---

<Layout content={{
    title: blog.title,
    description: blog.tags,
    heroImage: blog.eyecatch?.url ?? '',
    pubDate: new Date(blog.publishedAt).toLocaleDateString('ja-JP', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
    updatedDate: new Date(blog.updatedAt).toLocaleDateString('ja-JP'),
    tags: blog.tags ?? '',
    nextBlogId: nextBlogId,
    prevBlogId: prevBlogId,
    nextBlogTitle: nextBlogTitle,
    prevBlogTitle: prevBlogTitle
}}>

<!-- ブロックコンテンツの取得と本文作成 -->
{blog.articleContent.map((content) => {
  switch (content.fieldId) {
    case 'richText':
      article.push(content.richText)
      return
    case 'articleLink':
      article.push(`<a href=${content.articleLink}>${content.articleLink}</a>`)
      return
    case 'imageUrl':
      article.push(`<img src=${content.imageUrl} />`)
      return
    default:
      break;
  }
})}
<!-- 出来上がった記事本文をセット -->
<main set:html={article.join("")} />
</Layout>